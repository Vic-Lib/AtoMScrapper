#!/bin/bash
#https://www.accesstomemory.org/en/docs/2.4/admin-manual/maintenance/cli-import-export/#cli-bulk-import-xml
rm /home/maximus/xml/scrape/*

echo "######## EXPORTING FONDS ########"
IFS=$'\n'       # make newlines the only separator
set -f          # disable globbing
for i in $(cat < /home/maximus/xml/fonds); do
   echo "scraping fonds $i"
   curl -L -o /home/maximus/xml/scrape/$i.xml  "https://discoverarchives.library.utoronto.ca/index.php/$i;ead?sf_format=xml"
done

echo "finished scraping fonds"

#The database has to be purged because it doesn't delete the slug and clear database so AtoM gets too many records
php /usr/share/nginx/atom/symfony tools:purge --demo
php /usr/share/nginx/atom/symfony cc

echo "######## IMPORTING #######"
php /usr/share/nginx/atom/symfony import:bulk --update="delete-and-replace" /home/maximus/xml/scrape

echo "######## REBUILDING CACHE #######"
php /usr/share/nginx/atom/symfony cc & php /usr/share/nginx/atom/symfony search:populate

echo "######## SUCCESS #######"
